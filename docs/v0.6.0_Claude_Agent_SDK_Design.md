# v0.6.0 Claude Agent SDK Uplift â€” Design & Implementation Plan

**Status**: PROPOSED  
**Branch**: `feature/v0.6.0-claude-agent-sdk`  
**Target Release**: v0.6.0  
**Date**: Feb 7, 2026

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2026-02-07 | 0.1 | Cascade | Initial proposal |

---

## 1. Executive Summary

This release migrates the Claude runner from the basic Anthropic SDK to the official **Claude Agent SDK** (`claude-agent-sdk`), adds **Claude Skill files** support (global + per-workspace), implements **hooks** for pre/post tool validation, expands the **tool set**, and delivers **true E2E streaming** in the UI.

### Key Deliverables

| Feature | Description | Priority |
|---------|-------------|----------|
| **A) Claude Agent SDK Migration** | Replace `anthropic` with `claude-agent-sdk` | High |
| **B) Hooks Implementation** | Pre/post tool use validation hooks | High |
| **C) Expanded Tool Set** | Add grep, edit, glob, and more tools | Medium |
| **D) Claude Skill Files** | Global skills + per-workspace skills | High |
| **E) UI/UX Streaming E2E** | True streaming with partial results | High |

---

## 2. Current State Analysis

### 2.1 Current Claude Runner Architecture

```
claude-runner/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py      # FastAPI endpoints: /threads, /runs, /runs/{id}/events
â”‚   â”œâ”€â”€ agent.py     # Manual agent loop with anthropic.messages.stream()
â”‚   â”œâ”€â”€ tools.py     # 4 tools: read_file, write_file, list_files, bash
â”‚   â”œâ”€â”€ events.py    # SSE event formatting
â”‚   â””â”€â”€ config.py    # Environment config
â”œâ”€â”€ requirements.txt # anthropic==0.42.0
â””â”€â”€ Dockerfile
```

### 2.2 Current Limitations

| Limitation | Impact |
|------------|--------|
| Manual streaming event parsing | Fragile if Anthropic changes format |
| No hooks | Cannot validate/block tool calls |
| Limited tools (4) | Missing grep, edit, glob, etc. |
| No skill files | Cannot customize agent behavior per workspace |
| No MCP server support | Cannot extend with custom tools |
| Manual message history | No session forking/subagents |

---

## 3. Target Architecture

### 3.1 Claude Agent SDK Integration

```
claude-runner/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py           # FastAPI endpoints (unchanged API contract)
â”‚   â”œâ”€â”€ agent.py          # NEW: Uses claude-agent-sdk query() or ClaudeSDKClient
â”‚   â”œâ”€â”€ skills.py         # NEW: Skill file loader (global + workspace)
â”‚   â”œâ”€â”€ hooks.py          # NEW: Pre/post tool use hooks
â”‚   â”œâ”€â”€ tools.py          # EXPANDED: More tools via @tool decorator
â”‚   â”œâ”€â”€ events.py         # ADAPTED: Map SDK messages to SSE events
â”‚   â””â”€â”€ config.py         # EXPANDED: Skill paths, hook config
â”œâ”€â”€ skills/               # NEW: Global skill files
â”‚   â”œâ”€â”€ code-review/
â”‚   â”‚   â””â”€â”€ SKILL.md
â”‚   â”œâ”€â”€ security-audit/
â”‚   â”‚   â””â”€â”€ SKILL.md
â”‚   â””â”€â”€ healthcare-compliance/
â”‚       â””â”€â”€ SKILL.md
â”œâ”€â”€ requirements.txt      # claude-agent-sdk (replaces anthropic)
â””â”€â”€ Dockerfile            # Updated for SDK + CLI bundling
```

### 3.2 Skill Files Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Skill Loading Hierarchy                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. Global Skills (claude-runner container)                      â”‚
â”‚     â””â”€â”€ /app/skills/<skill-name>/SKILL.md                       â”‚
â”‚         - Available to ALL workspaces                            â”‚
â”‚         - Managed by platform admins                             â”‚
â”‚         - Examples: code-review, security-audit, compliance      â”‚
â”‚                                                                  â”‚
â”‚  2. Workspace Skills (per-workspace)                             â”‚
â”‚     â””â”€â”€ /workspaces/<id>/.claude/skills/<skill-name>/SKILL.md   â”‚
â”‚         - Available only to that workspace                       â”‚
â”‚         - Uploaded with workspace or created by users            â”‚
â”‚         - Examples: project-conventions, deploy, test-runner     â”‚
â”‚                                                                  â”‚
â”‚  3. Skill Resolution Order                                       â”‚
â”‚     workspace skills > global skills (workspace overrides)       â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Feature Specifications

### 4.1 Feature A: Claude Agent SDK Migration

#### 4.1.1 Package Change

```diff
# requirements.txt
- anthropic==0.42.0
+ claude-agent-sdk>=0.2.0
+ anyio>=4.0.0
```

#### 4.1.2 Agent Loop Rewrite

**Before** (manual streaming):
```python
# agent.py (current)
client = anthropic.Anthropic(api_key=ANTHROPIC_API_KEY)
with client.messages.stream(...) as stream:
    for event in stream:
        # Manual event parsing...
```

**After** (SDK-based):
```python
# agent.py (new)
from claude_agent_sdk import query, ClaudeAgentOptions, AssistantMessage, TextBlock, ToolUseBlock

async def run_agent_loop(thread_id, run_id, prompt, working_directory, skills):
    options = ClaudeAgentOptions(
        cwd=working_directory,
        system_prompt=build_system_prompt(skills),
        allowed_tools=["Read", "Write", "Bash", "Grep", "Glob", "Edit"],
        permission_mode="acceptEdits",
        max_turns=20,
        hooks=get_hooks(),
        mcp_servers=get_mcp_servers()
    )
    
    async for message in query(prompt=prompt, options=options):
        yield convert_to_sse(run_id, message)
```

#### 4.1.3 Event Mapping

| SDK Message Type | SSE Event Type |
|------------------|----------------|
| `AssistantMessage` with `TextBlock` | `ui.message.assistant.delta` / `ui.message.assistant.final` |
| `AssistantMessage` with `ToolUseBlock` | `ui.tool.call` |
| `ToolResultBlock` | `ui.tool.result` |
| `UserMessage` | `ui.message.user` |
| `ResultMessage` | `run.completed` |

---

### 4.2 Feature B: Hooks Implementation

#### 4.2.1 Hook Types

| Hook | Trigger | Use Case |
|------|---------|----------|
| `PreToolUse` | Before tool execution | Block dangerous commands, validate paths |
| `PostToolUse` | After tool execution | Log results, audit trail |

#### 4.2.2 Implementation

```python
# hooks.py
from claude_agent_sdk import HookMatcher

BLOCKED_PATTERNS = [
    "rm -rf /",
    "sudo",
    "chmod 777",
    "> /dev/",
    "curl | bash",
]

async def pre_tool_use_hook(input_data, tool_use_id, context):
    tool_name = input_data["tool_name"]
    tool_input = input_data["tool_input"]
    
    if tool_name == "Bash":
        command = tool_input.get("command", "")
        for pattern in BLOCKED_PATTERNS:
            if pattern in command:
                return {
                    "hookSpecificOutput": {
                        "hookEventName": "PreToolUse",
                        "permissionDecision": "deny",
                        "permissionDecisionReason": f"Blocked: {pattern}",
                    }
                }
    
    # Path escape check for file operations
    if tool_name in ["Read", "Write", "Edit"]:
        path = tool_input.get("path", "")
        if ".." in path or path.startswith("/"):
            return {
                "hookSpecificOutput": {
                    "hookEventName": "PreToolUse",
                    "permissionDecision": "deny",
                    "permissionDecisionReason": "Path escape attempt blocked",
                }
            }
    
    return {}  # Allow

def get_hooks():
    return {
        "PreToolUse": [
            HookMatcher(matcher="*", hooks=[pre_tool_use_hook]),
        ],
    }
```

---

### 4.3 Feature C: Expanded Tool Set

#### 4.3.1 New Tools

| Tool | Description | SDK Built-in |
|------|-------------|--------------|
| `Read` | Read file contents | Yes |
| `Write` | Write to file | Yes |
| `Edit` | Edit file with diff | Yes |
| `Bash` | Execute shell command | Yes |
| `Grep` | Search file contents | Yes |
| `Glob` | Find files by pattern | Yes |
| `ListDir` | List directory | Yes |
| `WebSearch` | Search the web | Optional |

#### 4.3.2 Custom Tools (MCP)

```python
# tools.py
from claude_agent_sdk import tool, create_sdk_mcp_server

@tool("healthcare_validate", "Validate healthcare data format", {"data": str, "format": str})
async def healthcare_validate(args):
    # Custom validation logic for NHS/healthcare data
    data = args["data"]
    format_type = args["format"]
    # ... validation logic
    return {"content": [{"type": "text", "text": f"Validation result: ..."}]}

def get_mcp_servers():
    return {
        "healthcare": create_sdk_mcp_server(
            name="healthcare-tools",
            version="1.0.0",
            tools=[healthcare_validate]
        )
    }
```

---

### 4.4 Feature D: Claude Skill Files

#### 4.4.1 Skill File Format (SKILL.md)

```markdown
---
name: code-review
description: Review code for quality, security, and best practices. Use when reviewing PRs, auditing code, or checking for issues.
allowed-tools: Read, Grep, Glob
---

# Code Review Skill

When reviewing code, follow these steps:

## 1. Security Check
- Look for hardcoded secrets, API keys, passwords
- Check for SQL injection, XSS vulnerabilities
- Verify input validation

## 2. Code Quality
- Check for code duplication
- Verify error handling
- Review naming conventions

## 3. Performance
- Look for N+1 queries
- Check for memory leaks
- Review async/await usage

## Output Format
Provide findings in this format:
- **Critical**: Issues that must be fixed
- **Warning**: Issues that should be addressed
- **Info**: Suggestions for improvement
```

#### 4.4.2 Global Skills (Platform-Wide)

Location: `claude-runner/skills/`

| Skill | Description |
|-------|-------------|
| `code-review` | Code quality and security review |
| `security-audit` | Security vulnerability scanning |
| `healthcare-compliance` | NHS/healthcare data compliance checks |
| `api-design` | REST API design best practices |
| `test-generator` | Generate unit tests |
| `documentation` | Generate/update documentation |

#### 4.4.3 Workspace Skills (Per-Project)

Location: `/workspaces/<id>/.claude/skills/`

Users can upload workspaces containing `.claude/skills/` directories with project-specific skills.

#### 4.4.4 Skill Loading Implementation

```python
# skills.py
import os
from pathlib import Path
import yaml

GLOBAL_SKILLS_PATH = "/app/skills"

def load_skill(skill_path: Path) -> dict | None:
    skill_md = skill_path / "SKILL.md"
    if not skill_md.exists():
        return None
    
    content = skill_md.read_text()
    
    # Parse YAML frontmatter
    if content.startswith("---"):
        parts = content.split("---", 2)
        if len(parts) >= 3:
            frontmatter = yaml.safe_load(parts[1])
            instructions = parts[2].strip()
            return {
                "name": frontmatter.get("name"),
                "description": frontmatter.get("description"),
                "allowed_tools": frontmatter.get("allowed-tools", "").split(", "),
                "instructions": instructions,
                "path": str(skill_path),
            }
    return None

def load_all_skills(workspace_path: str) -> list[dict]:
    skills = []
    
    # 1. Load global skills
    global_skills_dir = Path(GLOBAL_SKILLS_PATH)
    if global_skills_dir.exists():
        for skill_dir in global_skills_dir.iterdir():
            if skill_dir.is_dir():
                skill = load_skill(skill_dir)
                if skill:
                    skill["scope"] = "global"
                    skills.append(skill)
    
    # 2. Load workspace skills (override global)
    workspace_skills_dir = Path(workspace_path) / ".claude" / "skills"
    if workspace_skills_dir.exists():
        for skill_dir in workspace_skills_dir.iterdir():
            if skill_dir.is_dir():
                skill = load_skill(skill_dir)
                if skill:
                    skill["scope"] = "workspace"
                    # Remove global skill with same name
                    skills = [s for s in skills if s["name"] != skill["name"]]
                    skills.append(skill)
    
    return skills

def build_system_prompt(skills: list[dict]) -> str:
    base_prompt = """You are an AI coding assistant with access to a workspace directory. You can read files, write files, list directories, and execute bash commands to help the user with their coding tasks."""
    
    if not skills:
        return base_prompt
    
    skill_section = "\n\n## Available Skills\n\n"
    for skill in skills:
        skill_section += f"### {skill['name']}\n"
        skill_section += f"{skill['description']}\n\n"
        skill_section += f"{skill['instructions']}\n\n"
    
    return base_prompt + skill_section
```

---

### 4.5 Feature E: UI/UX Streaming E2E

#### 4.5.1 Current Streaming Issues

| Issue | Root Cause |
|-------|------------|
| No visible streaming | Frontend waits for full response |
| Sudden result appearance | SSE events buffered |
| No partial tool results | Tool results sent only after completion |

#### 4.5.2 Streaming Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    E2E Streaming Flow                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Claude Agent SDK                                                â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼ (AsyncIterator of typed messages)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚ claude-runnerâ”‚ â†’ Convert to SSE events                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼ (SSE: text/event-stream)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚   backend   â”‚ â†’ Proxy SSE (no buffering)                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼ (SSE passthrough)                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚  frontend   â”‚ â†’ Real-time UI updates                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                      Browser UI                              â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚ Message Stream                                          â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚ User: "Analyze this code"                           â”‚â”‚â”‚â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚ Assistant: "I'll analyze the code..."               â”‚â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚ [streaming text appears character by character]     â”‚â”‚â”‚â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚ ğŸ”§ Tool: read_file                                  â”‚â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚ Input: {"path": "src/main.py"}                      â”‚â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚ [collapsible, shows spinner while executing]        â”‚â”‚â”‚â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚ âœ… Tool Result: read_file                           â”‚â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚ [collapsible, shows file content preview]           â”‚â”‚â”‚â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.5.3 Frontend Streaming Implementation

**Key Changes**:

1. **Incremental text rendering**: Append `textDelta` to message as it arrives
2. **Tool call spinner**: Show spinner while tool is executing
3. **Collapsible tool results**: Expandable sections for tool I/O
4. **Progress indicators**: Show agent iteration count
5. **Skill indicators**: Show which skill is active

```typescript
// Frontend streaming state
interface StreamingState {
  currentMessage: string;
  pendingToolCalls: Map<string, ToolCall>;
  completedToolResults: ToolResult[];
  activeSkill: string | null;
  iteration: number;
  maxIterations: number;
}

// SSE event handler
function handleSSEEvent(event: SSEEvent, state: StreamingState) {
  switch (event.type) {
    case "ui.message.assistant.delta":
      // Append text incrementally
      state.currentMessage += event.payload.textDelta;
      renderMessage(state.currentMessage);
      break;
    
    case "ui.tool.call":
      // Show tool call with spinner
      state.pendingToolCalls.set(event.payload.toolId, {
        name: event.payload.toolName,
        input: event.payload.input,
        status: "executing",
      });
      renderToolCall(event.payload);
      break;
    
    case "ui.tool.result":
      // Replace spinner with result
      state.pendingToolCalls.delete(event.payload.toolId);
      state.completedToolResults.push(event.payload);
      renderToolResult(event.payload);
      break;
    
    case "ui.skill.activated":
      state.activeSkill = event.payload.skillName;
      renderSkillBadge(event.payload);
      break;
    
    case "run.completed":
      finalizeMessage(state);
      break;
  }
}
```

#### 4.5.4 New SSE Event Types

| Event Type | Payload | Description |
|------------|---------|-------------|
| `ui.skill.activated` | `{skillName, description}` | Skill loaded for this run |
| `ui.tool.call.start` | `{toolId, toolName, input}` | Tool execution started |
| `ui.tool.call.progress` | `{toolId, progress}` | Tool execution progress |
| `ui.iteration` | `{current, max}` | Agent loop iteration |

---

## 5. Implementation Plan

### Phase 1: Foundation (Days 1-2)

| Task | Description | Files |
|------|-------------|-------|
| 1.1 | Update requirements.txt with claude-agent-sdk | `claude-runner/requirements.txt` |
| 1.2 | Rewrite agent.py to use SDK | `claude-runner/app/agent.py` |
| 1.3 | Update Dockerfile for SDK | `claude-runner/Dockerfile` |
| 1.4 | Adapt events.py for SDK message types | `claude-runner/app/events.py` |

### Phase 2: Skills & Hooks (Days 3-4)

| Task | Description | Files |
|------|-------------|-------|
| 2.1 | Create skills.py loader | `claude-runner/app/skills.py` |
| 2.2 | Create global skill files | `claude-runner/skills/*/SKILL.md` |
| 2.3 | Implement hooks.py | `claude-runner/app/hooks.py` |
| 2.4 | Integrate skills/hooks into agent | `claude-runner/app/agent.py` |

### Phase 3: UI Streaming (Days 5-6)

| Task | Description | Files |
|------|-------------|-------|
| 3.1 | Update Agents tab streaming | `frontend/src/app/(app)/codex/page.tsx` |
| 3.2 | Update Chat UI streaming | `frontend/src/app/(app)/chat/page.tsx` |
| 3.3 | Add tool call/result components | `frontend/src/components/ToolCall.tsx` |
| 3.4 | Add skill badge component | `frontend/src/components/SkillBadge.tsx` |

### Phase 4: Testing & Documentation (Days 7-8)

| Task | Description | Files |
|------|-------------|-------|
| 4.1 | E2E streaming tests | `tests/test_streaming.py` |
| 4.2 | Skill loading tests | `tests/test_skills.py` |
| 4.3 | Hook validation tests | `tests/test_hooks.py` |
| 4.4 | Update Service_Guide.md | `docs/Service_Guide.md` |
| 4.5 | Update Release_Notes.md | `docs/Release_Notes.md` |

---

## 6. API Changes

### 6.1 New Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/skills` | GET | List available skills (global + workspace) |
| `/skills/{name}` | GET | Get skill details |

### 6.2 Updated Endpoints

| Endpoint | Change |
|----------|--------|
| `POST /runs` | Add optional `skills` array to enable specific skills |
| `GET /runs/{id}/events` | New event types for skills and streaming |

---

## 7. Configuration

### 7.1 Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `ANTHROPIC_API_KEY` | (required) | Anthropic API key |
| `CLAUDE_MODEL` | `claude-sonnet-4-20250514` | Model to use |
| `GLOBAL_SKILLS_PATH` | `/app/skills` | Path to global skills |
| `ENABLE_HOOKS` | `true` | Enable pre/post tool hooks |
| `MAX_AGENT_TURNS` | `20` | Max agent loop iterations |

### 7.2 Docker Compose Changes

```yaml
# docker-compose.yml
claude-runner:
  build: ./claude-runner
  environment:
    - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    - GLOBAL_SKILLS_PATH=/app/skills
    - ENABLE_HOOKS=true
  volumes:
    - ./workspaces:/workspaces
    # Skills are baked into the image, not mounted
```

---

## 8. Testing Strategy

### 8.1 Unit Tests

- Skill file parsing
- Hook validation logic
- Event conversion

### 8.2 Integration Tests

- SDK agent loop execution
- Skill loading from workspace
- SSE streaming E2E

### 8.3 Manual Tests

1. Create session with Claude runner
2. Run prompt that triggers skill
3. Verify streaming in UI
4. Verify tool calls show spinner
5. Verify hook blocks dangerous command

---

## 9. Rollback Plan

If issues arise:
1. Revert to `anthropic` SDK in requirements.txt
2. Restore original agent.py
3. Skills and hooks are additive (can be disabled via env var)

---

## 10. Success Criteria

| Metric | Target |
|--------|--------|
| Streaming latency | < 100ms from SDK to UI |
| Skill loading | < 50ms per workspace |
| Hook validation | < 10ms per tool call |
| E2E test pass rate | 100% |

---

## 11. Dependencies

| Dependency | Version | Purpose |
|------------|---------|---------|
| `claude-agent-sdk` | >= 0.2.0 | Official Claude Agent SDK |
| `anyio` | >= 4.0.0 | Async runtime for SDK |
| `pyyaml` | >= 6.0 | SKILL.md frontmatter parsing |

---

## 12. Open Questions

1. **CLI Bundling**: Should we bundle Claude Code CLI in Docker image or rely on SDK's bundled version?
2. **Skill Marketplace**: Future feature to browse/install skills from Anthropic's marketplace?
3. **Workspace Skill Upload UI**: Add UI to upload/manage workspace skills?

---

## Appendix A: Example Global Skills

### A.1 code-review/SKILL.md

```markdown
---
name: code-review
description: Review code for quality, security, and best practices. Use when the user asks for a code review, PR review, or audit.
allowed-tools: Read, Grep, Glob
---

# Code Review Skill

When reviewing code, follow this checklist:

## Security
- [ ] No hardcoded secrets or API keys
- [ ] Input validation on all user inputs
- [ ] SQL queries use parameterized statements
- [ ] No eval() or exec() with user input

## Code Quality
- [ ] Functions are small and focused
- [ ] Clear naming conventions
- [ ] Proper error handling
- [ ] No code duplication

## Performance
- [ ] No N+1 queries
- [ ] Efficient algorithms
- [ ] Proper caching where needed

Provide findings as:
- **Critical**: Must fix before merge
- **Warning**: Should address
- **Info**: Nice to have
```

### A.2 healthcare-compliance/SKILL.md

```markdown
---
name: healthcare-compliance
description: Check code for NHS/healthcare data compliance. Use when working with patient data, medical records, or healthcare systems.
allowed-tools: Read, Grep, Glob
---

# Healthcare Compliance Skill

When reviewing healthcare code, verify:

## Data Protection
- [ ] PII is encrypted at rest and in transit
- [ ] Access logging enabled
- [ ] Data retention policies implemented
- [ ] GDPR consent mechanisms

## NHS Specific
- [ ] NHS number validation
- [ ] Spine integration security
- [ ] Clinical safety standards (DCB0129)

## Audit Trail
- [ ] All data access logged
- [ ] User actions traceable
- [ ] Timestamps on all records

Flag any violations as **COMPLIANCE RISK**.
```
