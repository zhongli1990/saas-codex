# v0.2.0 Service Guide

This document provides comprehensive documentation of all services implemented in v0.2.0, including APIs, configuration, testing procedures, and operational guidance.

---

## Table of Contents

1. [Architecture Overview](#1-architecture-overview)
2. [Service Inventory](#2-service-inventory)
3. [Core Services](#3-core-services)
   - [Frontend](#31-frontend)
   - [Backend](#32-backend)
   - [Codex Runner](#33-codex-runner)
   - [Claude Runner](#34-claude-runner)
4. [Microservices](#4-microservices)
   - [Prompt Manager](#41-prompt-manager)
   - [Evaluation Service](#42-evaluation-service)
   - [Memory Service](#43-memory-service)
   - [LLM Gateway](#44-llm-gateway)
5. [Database](#5-database)
6. [Testing Procedures](#6-testing-procedures)
7. [Deployment](#7-deployment)
8. [Troubleshooting](#8-troubleshooting)

---

## 1. Architecture Overview

### System Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Browser (User)                                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Frontend (Next.js) :9100                             │
│  - Agent Console UI                                                          │
│  - Workspace import/selection                                                │
│  - Runner selection (Codex/Claude)                                           │
│  - Transcript view (Markdown)                                                │
│  - Raw events view (JSON)                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Backend (FastAPI) :9101                              │
│  - Workspace registry                                                        │
│  - Session management                                                        │
│  - Run orchestration                                                         │
│  - SSE proxy                                                                 │
└─────────────────────────────────────────────────────────────────────────────┘
                          │                    │
              ┌───────────┴────────┐           │
              ▼                    ▼           ▼
┌──────────────────────┐ ┌──────────────────────┐ ┌──────────────────────┐
│ Codex Runner :9102   │ │ Claude Runner :9104  │ │   PostgreSQL :9103   │
│ (Node.js)            │ │ (Python/FastAPI)     │ │                      │
│ - @openai/codex-sdk  │ │ - Anthropic SDK      │ │ - workspaces         │
│ - SSE streaming      │ │ - Tool use agent     │ │ - sessions           │
│ - Event buffering    │ │ - SSE streaming      │ │ - runs               │
└──────────────────────┘ └──────────────────────┘ │ - run_events         │
                                                   └──────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Microservices (Placeholders)                         │
├──────────────────┬──────────────────┬──────────────────┬────────────────────┤
│ Prompt Manager   │ Evaluation       │ Memory           │ LLM Gateway        │
│ :9105            │ :9106            │ :9107            │ :9108              │
└──────────────────┴──────────────────┴──────────────────┴────────────────────┘
```

### Data Flow

1. **User** opens Agent Console at `http://localhost:9100/codex`
2. **Frontend** proxies API calls to Backend via Next.js API routes
3. **Backend** manages workspaces, sessions, and routes to appropriate runner
4. **Runner** (Codex or Claude) executes agent loop and streams SSE events
5. **Backend** proxies SSE stream back to Frontend
6. **Frontend** renders transcript and raw events in real-time

---

## 2. Service Inventory

| Service | Technology | Port (Host) | Port (Container) | Status |
|---------|------------|-------------|------------------|--------|
| Frontend | Next.js 14 | 9100 | 3000 | ✅ Implemented |
| Backend | FastAPI | 9101 | 8080 | ✅ Implemented |
| Codex Runner | Node.js + Codex SDK | 9102 | 8081 | ✅ Implemented |
| Claude Runner | Python + Anthropic SDK | 9104 | 8082 | ✅ Implemented |
| PostgreSQL | PostgreSQL 16 | 9103 | 5432 | ✅ Running |
| Prompt Manager | FastAPI | 9105 | 8083 | ✅ Placeholder |
| Evaluation | FastAPI | 9106 | 8084 | ✅ Placeholder |
| Memory | FastAPI | 9107 | 8085 | ✅ Placeholder |
| LLM Gateway | FastAPI | 9108 | 8086 | ✅ Placeholder |

---

## 3. Core Services

### 3.1 Frontend

**Location**: `frontend/`

**Technology Stack**:
- Next.js 14 (App Router)
- React 18
- TailwindCSS
- react-markdown + remark-gfm

**Key Files**:
- `src/app/(app)/codex/page.tsx` - Main Agent Console
- `src/app/api/` - API route proxies

**Features Implemented**:
- Runner selection dropdown (Codex/Claude)
- GitHub URL input for workspace import
- Session creation with runner type
- Prompt input and execution
- Transcript view with Markdown rendering
- Raw events view with JSON display
- Tool call/result display with collapsible sections
- Auto-scroll on new content
- Status indicators (idle, running, completed, error)

**API Routes**:

| Route | Method | Proxies To |
|-------|--------|------------|
| `/api/sessions` | POST | `backend/api/sessions` |
| `/api/sessions/[sessionId]/prompt` | POST | `backend/api/sessions/{id}/prompt` |
| `/api/runs/[runId]/events` | GET | `backend/api/runs/{id}/events` (SSE) |
| `/api/workspaces` | GET | `backend/api/workspaces` |
| `/api/workspaces/import` | POST | `backend/api/workspaces/import` |
| `/api/workspaces/[workspaceId]` | GET | `backend/api/workspaces/{id}` |
| `/api/workspaces/[workspaceId]/sessions` | GET | `backend/api/workspaces/{id}/sessions` |

**Environment Variables**:
- `BACKEND_URL` - Backend service URL (default: `http://backend:8080`)
- `PORT` - Server port (default: `3000`)

**Testing**:
```bash
# Health check (via browser)
open http://localhost:9100

# Verify API proxy
curl http://localhost:9100/api/workspaces
```

---

### 3.2 Backend

**Location**: `backend/`

**Technology Stack**:
- Python 3.12
- FastAPI
- SQLAlchemy 2.0 (async)
- Alembic (migrations)
- httpx (async HTTP client)

**Key Files**:
- `app/main.py` - FastAPI application and endpoints
- `app/database.py` - Database engine configuration
- `app/models.py` - SQLAlchemy ORM models
- `alembic/` - Database migrations

**API Endpoints**:

#### Health Check
```
GET /health
Response: {"status": "ok"}
```

#### Workspace Registry

```
POST /api/workspaces/import
Request:
{
  "source_type": "github" | "local",
  "source_uri": "https://github.com/org/repo.git",
  "display_name": "optional name"
}
Response:
{
  "workspace_id": "uuid",
  "display_name": "org/repo",
  "source_type": "github",
  "source_uri": "https://github.com/org/repo.git",
  "local_path": "/workspaces/uuid/repo",
  "created_at": "2026-01-18T12:00:00Z"
}
```

```
GET /api/workspaces
Response:
{
  "items": [
    {
      "workspace_id": "uuid",
      "display_name": "org/repo",
      "source_type": "github",
      "source_uri": "...",
      "local_path": "...",
      "created_at": "..."
    }
  ]
}
```

```
GET /api/workspaces/{workspace_id}
Response: WorkspaceResponse
```

```
GET /api/workspaces/{workspace_id}/sessions
Response:
{
  "items": [
    {
      "session_id": "uuid",
      "workspace_id": "uuid",
      "runner_type": "codex" | "claude",
      "thread_id": "...",
      "created_at": "..."
    }
  ]
}
```

#### Session Management

```
POST /api/sessions
Request:
{
  "workspace_id": "uuid",  // OR
  "repo_url": "https://github.com/...",
  "runner_type": "codex" | "claude"
}
Response:
{
  "session_id": "uuid",
  "repo_path": "/workspaces/.../repo",
  "thread_id": "...",
  "runner_type": "codex",
  "workspace_id": "uuid"
}
```

```
GET /api/sessions/{session_id}
Response: SessionResponse
```

#### Run Execution

```
POST /api/sessions/{session_id}/prompt
Request:
{
  "prompt": "Analyze this codebase"
}
Response:
{
  "run_id": "uuid"
}
```

```
GET /api/runs/{run_id}/events
Response: SSE stream
Content-Type: text/event-stream

: connected

data: {"type": "run.started", "runId": "...", ...}

data: {"type": "ui.message.assistant.delta", "payload": {"textDelta": "..."}, ...}

data: {"type": "run.completed", ...}
```

#### Dashboard Stats (v0.3.0)

```
GET /api/stats/dashboard
Response:
{
  "workspaces_count": 3,
  "sessions_count": 12,
  "runs_today": 5,
  "runs_total": 47,
  "recent_activity": [
    {
      "type": "run",
      "status": "completed",
      "workspace_name": "mem0-test",
      "runner_type": "codex",
      "prompt_preview": "List the files...",
      "created_at": "2026-01-18T21:00:00Z"
    }
  ]
}
```

#### System Health (v0.3.0)

```
GET /api/health/services
Response:
{
  "services": [
    {"service": "backend", "status": "healthy", "latency_ms": 1},
    {"service": "codex_runner", "status": "healthy", "latency_ms": 15},
    {"service": "claude_runner", "status": "healthy", "latency_ms": 12},
    {"service": "database", "status": "healthy", "latency_ms": 1}
  ]
}
```

#### Authentication Endpoints (v0.4.0)

```
POST /api/auth/register
Request: {"email": "user@example.com", "password": "Password123", "display_name": "John Doe", "mobile": "+1234567890"}
Response: {"id": "uuid", "email": "user@example.com", "status": "pending", "role": "user", ...}

POST /api/auth/login
Request: {"email": "user@example.com", "password": "Password123"}
Response: {"access_token": "jwt...", "token_type": "bearer", "user": {...}}

GET /api/auth/me
Headers: Authorization: Bearer <token>
Response: {"id": "uuid", "email": "user@example.com", "status": "active", "role": "user", ...}

POST /api/auth/logout
Response: {"message": "Logged out successfully"}
```

#### Admin Endpoints (v0.4.0)

```
GET /api/admin/users
Headers: Authorization: Bearer <admin_token>
Query: ?status=pending (optional filter)
Response: [{"id": "uuid", "email": "...", "status": "pending", ...}, ...]

GET /api/admin/users/pending
Headers: Authorization: Bearer <admin_token>
Response: [{"id": "uuid", "email": "...", "status": "pending", ...}, ...]

POST /api/admin/users/{user_id}/approve
Headers: Authorization: Bearer <admin_token>
Response: {"id": "uuid", "status": "active", "approved_at": "...", ...}

POST /api/admin/users/{user_id}/reject
Headers: Authorization: Bearer <admin_token>
Response: {"id": "uuid", "status": "rejected", ...}

POST /api/admin/users/{user_id}/activate
Headers: Authorization: Bearer <admin_token>
Response: {"id": "uuid", "status": "active", ...}

POST /api/admin/users/{user_id}/deactivate
Headers: Authorization: Bearer <admin_token>
Response: {"id": "uuid", "status": "inactive", ...}
```

**Environment Variables**:
- `DATABASE_URL` - PostgreSQL connection string
- `WORKSPACES_ROOT` - Workspace storage directory (default: `/workspaces`)
- `RUNNER_URL` - Default runner URL (legacy)
- `RUNNER_CODEX_URL` - Codex runner URL
- `RUNNER_CLAUDE_URL` - Claude runner URL
- `PORT` - Server port (default: `8080`)
- `JWT_SECRET_KEY` - Secret key for JWT signing (v0.4.0)
- `JWT_EXPIRE_MINUTES` - Token expiration in minutes (default: 1440, v0.4.0)
- `ADMIN_EMAIL` - Initial admin email (default: admin@saas-codex.com, v0.4.0)
- `ADMIN_PASSWORD` - Initial admin password (default: Admin123!, v0.4.0)

**Testing**:
```bash
# Health check
curl http://localhost:9101/health

# Import workspace
curl -X POST http://localhost:9101/api/workspaces/import \
  -H "Content-Type: application/json" \
  -d '{"source_type": "github", "source_uri": "https://github.com/octocat/Hello-World.git"}'

# List workspaces
curl http://localhost:9101/api/workspaces

# Create session
curl -X POST http://localhost:9101/api/sessions \
  -H "Content-Type: application/json" \
  -d '{"repo_url": "https://github.com/octocat/Hello-World.git", "runner_type": "codex"}'

# Run prompt
curl -X POST http://localhost:9101/api/sessions/{session_id}/prompt \
  -H "Content-Type: application/json" \
  -d '{"prompt": "List the files in this repository"}'

# Stream events
curl -N http://localhost:9101/api/runs/{run_id}/events
```

---

### 3.3 Codex Runner

**Location**: `runner/`

**Technology Stack**:
- Node.js 20
- Express
- @openai/codex-sdk

**Key Files**:
- `src/server.ts` - Express server with SSE endpoints

**API Endpoints**:

```
GET /health
Response: {"status": "ok"}
```

```
POST /threads
Request:
{
  "workingDirectory": "/workspaces/uuid/repo",
  "skipGitRepoCheck": false
}
Response:
{
  "threadId": "uuid"
}
```

```
POST /runs
Request:
{
  "threadId": "uuid",
  "prompt": "Analyze this code"
}
Response:
{
  "runId": "uuid"
}
```

```
GET /runs/{runId}/events
Response: SSE stream
```

**Environment Variables**:
- `CODEX_API_KEY` - OpenAI API key for Codex
- `CODEX_SANDBOX_TYPE` - Sandbox mode (default: `none`)
- `WORKSPACES_ROOT` - Workspace directory
- `PORT` - Server port (default: `8081`)

**Testing**:
```bash
# Health check
curl http://localhost:9102/health

# Create thread
curl -X POST http://localhost:9102/threads \
  -H "Content-Type: application/json" \
  -d '{"workingDirectory": "/workspaces/test", "skipGitRepoCheck": true}'

# Start run
curl -X POST http://localhost:9102/runs \
  -H "Content-Type: application/json" \
  -d '{"threadId": "...", "prompt": "Hello"}'

# Stream events
curl -N http://localhost:9102/runs/{runId}/events
```

---

### 3.4 Claude Runner

**Location**: `claude-runner/`

**Technology Stack**:
- Python 3.12
- FastAPI
- Anthropic SDK
- Uvicorn

**Key Files**:
- `app/main.py` - FastAPI application
- `app/agent.py` - Agent loop with tool use
- `app/tools.py` - Tool definitions and executors
- `app/events.py` - Event envelope helpers
- `app/config.py` - Configuration

**Tools Available**:
| Tool | Description |
|------|-------------|
| `read_file` | Read file contents |
| `write_file` | Write content to file |
| `list_files` | List directory contents |
| `bash` | Execute bash command |

**API Endpoints**:
Same contract as Codex Runner:
- `GET /health`
- `POST /threads`
- `POST /runs`
- `GET /runs/{runId}/events` (SSE)

**Environment Variables**:
- `ANTHROPIC_API_KEY` - Anthropic API key
- `WORKSPACES_ROOT` - Workspace directory
- `CLAUDE_MODEL` - Model to use (default: `claude-sonnet-4-20250514`)
- `PORT` - Server port (default: `8082`)

**Testing**:
```bash
# Health check
curl http://localhost:9104/health

# Create thread
curl -X POST http://localhost:9104/threads \
  -H "Content-Type: application/json" \
  -d '{"workingDirectory": "/workspaces/test", "skipGitRepoCheck": true}'

# Start run
curl -X POST http://localhost:9104/runs \
  -H "Content-Type: application/json" \
  -d '{"threadId": "...", "prompt": "List files in this directory"}'

# Stream events
curl -N http://localhost:9104/runs/{runId}/events
```

---

## 4. Microservices

### 4.1 Prompt Manager

**Location**: `prompt-manager/`

**Purpose**: Store and render parameterized prompt templates.

**API Endpoints**:

```
GET /health
Response: {"status": "ok"}
```

```
POST /templates
Request:
{
  "name": "code-review",
  "description": "Review code for issues",
  "template": "Review the following code for {{criteria}}:\n\n{{code}}",
  "variables": ["criteria", "code"]
}
Response:
{
  "template_id": "uuid",
  "name": "code-review",
  "description": "...",
  "template": "...",
  "variables": ["criteria", "code"],
  "created_at": "...",
  "version": 1
}
```

```
GET /templates
Response: {"items": [...]}
```

```
GET /templates/{template_id}
Response: TemplateResponse
```

```
POST /templates/{template_id}/render
Request:
{
  "params": {
    "criteria": "security vulnerabilities",
    "code": "function login(user, pass) { ... }"
  }
}
Response:
{
  "rendered": "Review the following code for security vulnerabilities:\n\nfunction login(user, pass) { ... }"
}
```

**Testing**:
```bash
# Health check
curl http://localhost:9105/health

# Create template
curl -X POST http://localhost:9105/templates \
  -H "Content-Type: application/json" \
  -d '{"name": "test", "template": "Hello {{name}}", "variables": ["name"]}'

# Render template
curl -X POST http://localhost:9105/templates/{id}/render \
  -H "Content-Type: application/json" \
  -d '{"params": {"name": "World"}}'
```

---

### 4.2 Evaluation Service

**Location**: `evaluation/`

**Purpose**: Score agent outputs against criteria. LangSmith integration placeholder.

**API Endpoints**:

```
GET /health
Response: {"status": "ok"}
```

```
POST /evaluate
Request:
{
  "input": {"prompt": "Analyze this code"},
  "output": {"text": "The code has 3 issues..."},
  "criteria": ["accuracy", "safety", "completeness"],
  "context": {"workspace_id": "...", "run_id": "..."}
}
Response:
{
  "scores": {
    "accuracy": 0.8,
    "safety": 0.8,
    "completeness": 0.8
  },
  "overall": 0.8,
  "notes": "Placeholder evaluation. LangSmith integration pending."
}
```

**Testing**:
```bash
# Health check
curl http://localhost:9106/health

# Evaluate
curl -X POST http://localhost:9106/evaluate \
  -H "Content-Type: application/json" \
  -d '{"input": {"prompt": "test"}, "output": {"text": "result"}, "criteria": ["accuracy"]}'
```

---

### 4.3 Memory Service

**Location**: `memory/`

**Purpose**: Store and retrieve session/workspace-scoped memories.

**API Endpoints**:

```
GET /health
Response: {"status": "ok"}
```

```
POST /memories
Request:
{
  "scope": "session" | "workspace",
  "scope_id": "uuid",
  "kind": "episodic" | "long_term",
  "text": "User prefers detailed explanations",
  "tags": ["preference", "style"]
}
Response:
{
  "id": "uuid",
  "scope": "session",
  "scope_id": "...",
  "kind": "episodic",
  "text": "...",
  "tags": ["preference", "style"],
  "created_at": "..."
}
```

```
POST /memories/query
Request:
{
  "scope": "session",
  "scope_id": "uuid",
  "query": "user preferences",
  "top_k": 10
}
Response:
{
  "items": [
    {"id": "...", "text": "...", "score": 0.5, "tags": [...]}
  ]
}
```

**Testing**:
```bash
# Health check
curl http://localhost:9107/health

# Store memory
curl -X POST http://localhost:9107/memories \
  -H "Content-Type: application/json" \
  -d '{"scope": "session", "scope_id": "test", "text": "Test memory", "tags": ["test"]}'

# Query memories
curl -X POST http://localhost:9107/memories/query \
  -H "Content-Type: application/json" \
  -d '{"scope": "session", "scope_id": "test", "query": "test", "top_k": 5}'
```

---

### 4.4 LLM Gateway

**Location**: `llm-gateway/`

**Purpose**: Unified LLM API with usage logging. Centralizes provider credentials.

**API Endpoints**:

```
GET /health
Response: {"status": "ok"}
```

```
POST /chat
Request:
{
  "provider": "openai" | "anthropic",
  "model": "gpt-4" | "claude-sonnet-4-20250514",
  "messages": [
    {"role": "system", "content": "You are a helpful assistant"},
    {"role": "user", "content": "Hello"}
  ],
  "metadata": {"tenant_id": "...", "run_id": "..."}
}
Response:
{
  "text": "[Placeholder response]",
  "usage": {"input_tokens": 100, "output_tokens": 50}
}
```

```
GET /usage
Response:
{
  "entries": [...],
  "total_count": 42
}
```

**Testing**:
```bash
# Health check
curl http://localhost:9108/health

# Chat (placeholder)
curl -X POST http://localhost:9108/chat \
  -H "Content-Type: application/json" \
  -d '{"provider": "openai", "model": "gpt-4", "messages": [{"role": "user", "content": "Hello"}]}'

# Usage log
curl http://localhost:9108/usage
```

---

## 5. Database

**Technology**: PostgreSQL 16

**Connection**: `postgresql://saas:saas@localhost:9103/saas`

### Schema

#### workspaces
| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| tenant_id | UUID | Tenant identifier (nullable) |
| source_type | VARCHAR(50) | `github`, `local` |
| source_uri | TEXT | Original source URL/path |
| storage_mode | VARCHAR(50) | `managed_copy` |
| display_name | TEXT | Human-readable name |
| local_path | TEXT | Path under WORKSPACES_ROOT |
| created_at | TIMESTAMPTZ | Creation timestamp |
| last_accessed_at | TIMESTAMPTZ | Last access (nullable) |
| metadata_json | JSONB | Additional metadata |

#### sessions
| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| tenant_id | UUID | Tenant identifier (nullable) |
| workspace_id | UUID | FK to workspaces |
| runner_type | VARCHAR(50) | `codex`, `claude` |
| runner_thread_id | TEXT | Thread ID from runner |
| working_directory | TEXT | Session working directory |
| created_at | TIMESTAMPTZ | Creation timestamp |

#### runs
| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| tenant_id | UUID | Tenant identifier (nullable) |
| session_id | UUID | FK to sessions |
| runner_run_id | TEXT | Run ID from runner |
| prompt | TEXT | User prompt |
| status | VARCHAR(50) | `running`, `completed`, `error` |
| created_at | TIMESTAMPTZ | Creation timestamp |
| completed_at | TIMESTAMPTZ | Completion timestamp |

#### run_events
| Column | Type | Description |
|--------|------|-------------|
| id | BIGSERIAL | Primary key |
| run_id | UUID | FK to runs |
| seq | INTEGER | Sequence number |
| at | TIMESTAMPTZ | Event timestamp |
| source | VARCHAR(50) | `runner` |
| event_type | VARCHAR(100) | Event type |
| raw_json | JSONB | Raw event data |

### Migrations

```bash
cd backend

# Run migrations
alembic upgrade head

# Create new migration
alembic revision --autogenerate -m "description"

# Rollback
alembic downgrade -1
```

---

## 6. Testing Procedures

### 6.1 Service Health Checks

```bash
# All services
for port in 9100 9101 9102 9104 9105 9106 9107 9108; do
  echo "Port $port: $(curl -s http://localhost:$port/health 2>/dev/null || echo 'FAILED')"
done
```

### 6.2 E2E Test Script

```bash
cd tests
pip install -r requirements.txt

# Test Codex runner
python test_sse_streaming.py --runner codex

# Test Claude runner
python test_sse_streaming.py --runner claude

# Test both
python test_sse_streaming.py --runner both
```

### 6.3 Manual E2E Test

1. **Start services**:
   ```bash
   docker compose up --build
   ```

2. **Open browser**:
   ```
   http://localhost:9100/codex
   ```

3. **Test Codex workflow**:
   - Enter: `https://github.com/octocat/Hello-World.git`
   - Select: Codex
   - Click: Create Session
   - Enter prompt: `List the files in this repository`
   - Click: Run Prompt
   - Verify: Transcript shows response

4. **Test Claude workflow**:
   - Refresh page
   - Enter: `https://github.com/octocat/Hello-World.git`
   - Select: Claude
   - Click: Create Session
   - Enter prompt: `What files are in this repository?`
   - Click: Run Prompt
   - Verify: Transcript shows response with tool calls

5. **Test Raw Events**:
   - Click: Raw Events tab
   - Verify: JSON events displayed

### 6.4 SSE Streaming Test

```bash
# Direct runner test
curl -N http://localhost:9102/runs/{runId}/events

# Backend proxy test
curl -N http://localhost:9101/api/runs/{runId}/events

# Frontend proxy test
curl -N http://localhost:9100/api/runs/{runId}/events
```

Expected:
- Connection opens immediately
- `: connected` comment arrives first
- Events stream incrementally
- Stream closes after `run.completed`

---

## 7. Deployment

### 7.1 Docker Compose (Development)

```bash
# Start all services
docker compose up --build

# Start specific services
docker compose up frontend backend runner

# View logs
docker compose logs -f backend

# Rebuild single service
docker compose build backend && docker compose up -d backend
```

### 7.2 Environment Variables

Create `.env` at repository root:

```bash
# Required for Codex runner
CODEX_API_KEY=sk-...

# Required for Claude runner
ANTHROPIC_API_KEY=sk-ant-...

# Optional for LLM Gateway
OPENAI_API_KEY=sk-...

# Optional for Evaluation service
LANGSMITH_API_KEY=...
LANGSMITH_PROJECT=saas-codex
```

### 7.3 Volume Mounts

| Volume | Purpose |
|--------|---------|
| `./workspaces:/workspaces` | Cloned repositories and session data |
| `postgres_data` | PostgreSQL data persistence |

---

## 8. Troubleshooting

### Service Won't Start

```bash
# Check logs
docker compose logs {service_name}

# Check port conflicts
lsof -i :9100

# Rebuild
docker compose build --no-cache {service_name}
```

### SSE Not Streaming

1. Check headers in response:
   ```bash
   curl -v http://localhost:9101/api/runs/{runId}/events
   ```
   Should include:
   - `Content-Type: text/event-stream`
   - `Cache-Control: no-cache, no-transform`
   - `X-Accel-Buffering: no`

2. Check runner is producing events:
   ```bash
   docker compose logs -f runner
   ```

### Database Connection Failed

```bash
# Check Postgres is running
docker compose ps postgres

# Check connection
docker compose exec postgres psql -U saas -d saas -c "SELECT 1"

# Run migrations
docker compose exec backend alembic upgrade head
```

### Claude Runner API Errors

1. Verify API key is set:
   ```bash
   docker compose exec claude-runner env | grep ANTHROPIC
   ```

2. Check model availability:
   - Ensure `claude-sonnet-4-20250514` is accessible with your API key

---

## Appendix: Event Schema

### Normalized Event Envelope

```json
{
  "v": 1,
  "runId": "uuid",
  "provider": "codex" | "claude",
  "kind": "raw" | "ui",
  "type": "event.type",
  "at": "2026-01-18T12:00:00Z",
  "seq": 1,
  "payload": {}
}
```

### UI Event Types

| Type | Payload | Description |
|------|---------|-------------|
| `ui.run.started` | `{sessionId}` | Run started |
| `ui.run.completed` | `{}` | Run completed |
| `ui.run.error` | `{message}` | Run error |
| `ui.message.user` | `{text}` | User message |
| `ui.message.assistant.delta` | `{textDelta}` | Streaming text |
| `ui.message.assistant.final` | `{text, format}` | Final message |
| `ui.tool.call` | `{toolName, input}` | Tool invocation |
| `ui.tool.result` | `{toolName, output}` | Tool result |

---

## 9. Production Deployment (Non-Dev Environments)

This section covers deploying saas-codex to production cloud environments (AWS, GCP, Azure, etc.).

### 9.1 Clean Deployment from Scratch

When deploying to a new environment or upgrading from an older version:

```bash
# 1. Clone the repository
git clone https://github.com/zhongli1990/saas-codex.git
cd saas-codex

# 2. Checkout the desired version
git checkout v0.4.0  # or main for latest

# 3. Create environment file
cat > .env << EOF
CODEX_API_KEY=your_openai_api_key
ANTHROPIC_API_KEY=your_anthropic_api_key
JWT_SECRET_KEY=your-production-secret-key-min-32-chars
ADMIN_EMAIL=admin@yourdomain.com
ADMIN_PASSWORD=YourSecurePassword123!
EOF

# 4. Build and start all services
docker compose build --no-cache
docker compose up -d

# 5. Verify services are running
docker compose ps
docker compose logs backend | grep -i "admin"
```

### 9.2 Upgrading from Previous Version

**IMPORTANT**: Docker volumes persist across `docker compose down`. To ensure a clean upgrade:

```bash
# 1. Stop all services and REMOVE VOLUMES
docker compose down -v

# 2. Remove all cached images (optional but recommended)
docker system prune -a

# 3. Pull latest code
git fetch origin
git checkout main
git pull origin main

# 4. Rebuild all images from scratch
docker compose build --no-cache

# 5. Start fresh
docker compose up -d

# 6. Verify new version is running
docker compose logs backend | head -50
```

**Warning**: `docker compose down -v` will delete all data including:
- PostgreSQL database (workspaces, sessions, runs, users)
- Any persisted state

This is expected for a clean upgrade. Back up data if needed.

### 9.3 Common Issues

#### Old UI Still Showing After Upgrade

**Cause**: Docker volumes persist database state from old version.

**Solution**:
```bash
docker compose down -v
docker system prune -a
docker compose build --no-cache
docker compose up -d
```

#### Migration Errors

**Cause**: Database schema mismatch between versions.

**Solution**:
```bash
# Run migrations manually
docker compose exec backend alembic upgrade head

# Or clean start
docker compose down -v
docker compose up -d
```

#### Initial Admin Not Created

**Cause**: Database already has data from previous run.

**Solution**:
```bash
# Check if admin exists
docker compose exec postgres psql -U saas -d saas -c "SELECT email, role FROM users WHERE role='admin';"

# If no admin, clean restart
docker compose down -v
docker compose up -d
```

### 9.4 Production Environment Variables

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `CODEX_API_KEY` | Yes | - | OpenAI API key for Codex runner |
| `ANTHROPIC_API_KEY` | Yes | - | Anthropic API key for Claude runner |
| `JWT_SECRET_KEY` | Yes | dev-secret-... | **MUST CHANGE** for production |
| `JWT_EXPIRE_MINUTES` | No | 1440 | Token expiry (24 hours) |
| `ADMIN_EMAIL` | No | admin@saas-codex.com | Initial admin email |
| `ADMIN_PASSWORD` | No | Admin123! | **MUST CHANGE** for production |
| `DATABASE_URL` | No | postgres://... | PostgreSQL connection string |

### 9.5 Security Checklist for Production

- [ ] Change `JWT_SECRET_KEY` to a secure random string (min 32 characters)
- [ ] Change `ADMIN_PASSWORD` to a strong password
- [ ] Use HTTPS (configure reverse proxy like nginx or cloud load balancer)
- [ ] Restrict network access to database port (9103)
- [ ] Set up proper firewall rules
- [ ] Enable rate limiting on auth endpoints (future enhancement)
- [ ] Configure backup for PostgreSQL data volume

### 9.6 Cloud-Specific Notes

#### AWS EC2

```bash
# Install Docker
sudo yum update -y
sudo yum install -y docker
sudo service docker start
sudo usermod -a -G docker ec2-user

# Install Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Open ports in security group: 9100 (frontend), 9101 (backend API)
```

#### Docker Compose Production Override

Create `docker-compose.prod.yml` for production overrides:

```yaml
version: "3.8"
services:
  frontend:
    restart: always
  backend:
    restart: always
    environment:
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
  postgres:
    restart: always
    volumes:
      - postgres_data:/var/lib/postgresql/data
```

Run with:
```bash
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

