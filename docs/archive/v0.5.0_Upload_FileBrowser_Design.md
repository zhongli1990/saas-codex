# v0.5.0 Upload & File Browser Feature Design

> **Status**: ğŸ”œ PLANNED
> **Target Release**: v0.5.0
> **Branch**: `dev/v0.5.0`
> **Created**: Feb 6, 2026
> **Author**: Cascade AI Assistant

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature 1: Local Folder Upload](#2-feature-1-local-folder-upload)
3. [Feature 2: Workspace File Browser & Download](#3-feature-2-workspace-file-browser--download)
4. [RBAC Model for File Access](#4-rbac-model-for-file-access)
5. [API Specification](#5-api-specification)
6. [Frontend Implementation](#6-frontend-implementation)
7. [Database Schema Changes](#7-database-schema-changes)
8. [Security Considerations](#8-security-considerations)
9. [Implementation Checklist](#9-implementation-checklist)

---

## 1. Executive Summary

v0.5.0 introduces two major features to enhance workspace management and content accessibility:

1. **Local Folder Upload**: Users can upload entire project folders from their local machine (browser) to the server's workspace, complementing the existing GitHub import and server-side scan features.

2. **Workspace File Browser & Download**: Users can browse, view, upload to, and download files from workspace directories. This enables access to AI-generated content, revised documents, and any workspace artifacts.

### Key Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| **Upload Size Limit** | 1GB max | Balance between usability and server resources |
| **File Type Restrictions** | None | Upload entire folders as-is, including all file types |
| **RBAC Model** | Workspace-level with group membership | NHS Trust multi-tenancy requires proper isolation |
| **UI Integration** | Agents Tab + Chat UI | Unified experience across both interfaces |

---

## 2. Feature 1: Local Folder Upload

### 2.1 Current State

| Import Method | Description | Status |
|---------------|-------------|--------|
| **GitHub Import** | Clone from GitHub URL | âœ… Implemented |
| **Server Scan** | Scan `/workspaces` for manually copied folders | âœ… Implemented |
| **Local Upload** | Upload folder from browser | ğŸ”œ v0.5.0 |

### 2.2 User Flow

```
1. User clicks "ğŸ“¤ Upload" button in Agents Tab
2. Upload modal opens with drag-and-drop zone
3. User selects folder or drags folder onto zone
4. Browser zips folder contents (using JSZip)
5. Progress bar shows upload status
6. Backend extracts ZIP to /workspaces/{id}/repo/
7. Workspace registered in database
8. User can immediately select and use workspace
```

### 2.3 UI Design

#### Button Placement (Agents Tab - Workspace Panel)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Workspace                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [+ Import]  [ğŸ” Scan]  [ğŸ“¤ Upload]  [ğŸ—‘ï¸ Remove]             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Select a workspace...                                    â–¼  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Upload Modal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Upload Local Folder                                       [âœ•]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Workspace Name:                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ my-integration-project                                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                              â”‚â”‚
â”‚  â”‚     ğŸ“ Drag & drop a folder here, or click to browse        â”‚â”‚
â”‚  â”‚                                                              â”‚â”‚
â”‚  â”‚     Maximum size: 1GB                                        â”‚â”‚
â”‚  â”‚     All files will be uploaded as-is                         â”‚â”‚
â”‚  â”‚                                                              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  Selected: my-project/ (23 files, 1.2 MB)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ â–¶ src/ (12 files)                                           â”‚â”‚
â”‚  â”‚ â–¶ tests/ (5 files)                                          â”‚â”‚
â”‚  â”‚   README.md                                                  â”‚â”‚
â”‚  â”‚   package.json                                               â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  Upload Progress: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 67%            â”‚
â”‚                                                                  â”‚
â”‚  [Cancel]                                    [Upload & Import]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 Technical Implementation

#### Browser-Side (Frontend)

```typescript
// Using webkitdirectory for folder selection
<input 
  type="file" 
  webkitdirectory 
  directory 
  multiple 
  onChange={handleFolderSelect}
/>

// Zip files using JSZip before upload
import JSZip from 'jszip';

async function zipFolder(files: FileList): Promise<Blob> {
  const zip = new JSZip();
  for (const file of files) {
    // file.webkitRelativePath contains the folder structure
    zip.file(file.webkitRelativePath, file);
  }
  return await zip.generateAsync({ type: 'blob' });
}
```

#### Backend Endpoint

```python
@app.post("/api/workspaces/upload", response_model=WorkspaceResponse)
async def upload_workspace(
    file: UploadFile = File(...),
    display_name: str = Form(...),
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user)
) -> WorkspaceResponse:
    """
    Upload a zipped folder as a new workspace.
    
    - Max size: 1GB
    - Extracts to /workspaces/{workspace_id}/repo/
    - Registers with source_type="upload"
    """
```

---

## 3. Feature 2: Workspace File Browser & Download

### 3.1 Purpose

Enable users to:
- Browse files and directories within a workspace
- View file contents (text files, code, markdown)
- Download individual files
- Download entire folders as ZIP
- Upload additional files to workspace
- Access AI-generated/revised content

### 3.2 UI Design

#### Agents Tab - Output Panel (New "Files" Tab)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Output                                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [Transcript] [Raw Events] [ğŸ“ Files]                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ“ Workspace: my-integration-project                         â”‚ â”‚
â”‚ â”‚ Path: /output                              [â¬†] [ğŸ ] [â¬† Upload]â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚                                                              â”‚ â”‚
â”‚ â”‚ ğŸ“ reports/                                        [Browse]  â”‚ â”‚
â”‚ â”‚ ğŸ“„ analysis-report.md         15.2 KB    [View] [â¬‡ Download] â”‚ â”‚
â”‚ â”‚ ğŸ“„ generated-spec.json         8.1 KB    [View] [â¬‡ Download] â”‚ â”‚
â”‚ â”‚ ğŸ“„ implementation-plan.md     12.4 KB    [View] [â¬‡ Download] â”‚ â”‚
â”‚ â”‚ ğŸ“„ test-cases.yaml             3.2 KB    [View] [â¬‡ Download] â”‚ â”‚
â”‚ â”‚                                                              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚ [â¬‡ Download All as ZIP]                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Chat UI - Sidebar Files Panel

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ Workspace     â”‚  â”‚                                            â”‚â”‚
â”‚ â”‚ [dropdown]    â”‚  â”‚  Chat messages...                          â”‚â”‚
â”‚ â”‚               â”‚  â”‚                                            â”‚â”‚
â”‚ â”‚ Sessions      â”‚  â”‚                                            â”‚â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚                                            â”‚â”‚
â”‚ â”‚ â”‚ codex     â”‚â”‚  â”‚                                            â”‚â”‚
â”‚ â”‚ â”‚ claude    â”‚â”‚  â”‚                                            â”‚â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚                                            â”‚â”‚
â”‚ â”‚               â”‚  â”‚                                            â”‚â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚                                            â”‚â”‚
â”‚ â”‚ ğŸ“ Files      â”‚  â”‚                                            â”‚â”‚
â”‚ â”‚ Path: /       â”‚  â”‚                                            â”‚â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚                                            â”‚â”‚
â”‚ â”‚ â”‚ğŸ“ src/    â”‚â”‚  â”‚                                            â”‚â”‚
â”‚ â”‚ â”‚ğŸ“ output/ â”‚â”‚  â”‚                                            â”‚â”‚
â”‚ â”‚ â”‚ğŸ“„ README  â”‚â”‚  â”‚                                            â”‚â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚                                            â”‚â”‚
â”‚ â”‚ [â¬† Upload]   â”‚  â”‚                                            â”‚â”‚
â”‚ â”‚ [â¬‡ Download] â”‚  â”‚                                            â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### File Viewer Modal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“„ analysis-report.md                                     [âœ•]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Path: /output/analysis-report.md                                 â”‚
â”‚ Size: 15.2 KB | Modified: Feb 6, 2026 14:30                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚ # Integration Analysis Report                                    â”‚
â”‚                                                                  â”‚
â”‚ ## Summary                                                       â”‚
â”‚ This document provides a comprehensive analysis of the          â”‚
â”‚ HL7v2 ADT message handling implementation...                    â”‚
â”‚                                                                  â”‚
â”‚ ## Key Findings                                                  â”‚
â”‚ - Message flow identified across 12 components                  â”‚
â”‚ - 3 potential issues detected                                   â”‚
â”‚ ...                                                              â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Copy to Clipboard]                              [â¬‡ Download]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. RBAC Model for File Access

### 4.1 Multi-Tenancy Model

saas-codex is a SaaS platform serving multiple NHS Trust organizations. Each Trust is a **tenant** with isolated data and users.

```
Tenant (NHS Trust)
    â”‚
    â”œâ”€â”€ Users
    â”‚     â”œâ”€â”€ Admin (full access)
    â”‚     â”œâ”€â”€ User (standard access)
    â”‚     â””â”€â”€ Viewer (read-only)
    â”‚
    â”œâ”€â”€ Groups
    â”‚     â”œâ”€â”€ Integration Team
    â”‚     â”œâ”€â”€ Clinical Informatics
    â”‚     â””â”€â”€ Compliance
    â”‚
    â””â”€â”€ Workspaces
          â”œâ”€â”€ Workspace A (owned by User X)
          â”œâ”€â”€ Workspace B (shared with Group Y)
          â””â”€â”€ Workspace C (tenant-wide)
```

### 4.2 Permission Model

| Permission | Description | Admin | User | Viewer |
|------------|-------------|-------|------|--------|
| `workspace:create` | Create new workspaces | âœ… | âœ… | âŒ |
| `workspace:delete` | Delete workspaces | âœ… | Owner only | âŒ |
| `workspace:read` | View workspace metadata | âœ… | âœ… | âœ… |
| `files:browse` | Browse workspace files | âœ… | âœ… | âœ… |
| `files:download` | Download files | âœ… | âœ… | âœ… |
| `files:upload` | Upload files to workspace | âœ… | âœ… | âŒ |
| `files:delete` | Delete files from workspace | âœ… | Owner only | âŒ |

### 4.3 Workspace Access Rules

```python
class WorkspaceAccess:
    """Determines who can access a workspace."""
    
    # Access levels
    OWNER = "owner"      # Full control
    EDITOR = "editor"    # Read + write files
    VIEWER = "viewer"    # Read-only
    
    def can_access(user: User, workspace: Workspace, permission: str) -> bool:
        # 1. Tenant isolation: user must belong to workspace's tenant
        if user.tenant_id != workspace.tenant_id:
            return False
        
        # 2. Admin override: tenant admins have full access
        if user.role == "admin":
            return True
        
        # 3. Owner access: workspace creator has full access
        if workspace.owner_id == user.id:
            return True
        
        # 4. Group access: check if user's groups have access
        for group in user.groups:
            access = WorkspaceGroupAccess.get(workspace.id, group.id)
            if access and access.has_permission(permission):
                return True
        
        # 5. Default: deny
        return False
```

### 4.4 Database Schema for RBAC

```sql
-- User groups for RBAC
CREATE TABLE groups (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(tenant_id, name)
);

-- User-group membership
CREATE TABLE user_groups (
    user_id UUID NOT NULL REFERENCES users(id),
    group_id UUID NOT NULL REFERENCES groups(id),
    role VARCHAR(20) DEFAULT 'member',  -- member, admin
    added_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (user_id, group_id)
);

-- Workspace access grants
CREATE TABLE workspace_access (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workspace_id UUID NOT NULL REFERENCES workspaces(id),
    grantee_type VARCHAR(20) NOT NULL,  -- user, group
    grantee_id UUID NOT NULL,
    access_level VARCHAR(20) NOT NULL,  -- owner, editor, viewer
    granted_at TIMESTAMPTZ DEFAULT NOW(),
    granted_by UUID REFERENCES users(id),
    UNIQUE(workspace_id, grantee_type, grantee_id)
);

-- Add owner_id to workspaces
ALTER TABLE workspaces ADD COLUMN owner_id UUID REFERENCES users(id);
```

### 4.5 Default Access Policy (v0.5.0)

For v0.5.0, implement with sensible defaults:

| Scenario | Default Access |
|----------|----------------|
| Workspace creator | Full owner access |
| Same tenant users | Download access (viewer) |
| Different tenant | No access |
| Unauthenticated | No access |

---

## 5. API Specification

### 5.1 Workspace Upload

```yaml
POST /api/workspaces/upload
Content-Type: multipart/form-data
Authorization: Bearer {token}

Request:
  file: <zip_file>           # Required, max 1GB
  display_name: string       # Required

Response: 201 Created
{
  "workspace_id": "uuid",
  "display_name": "my-project",
  "source_type": "upload",
  "source_uri": "upload://my-project",
  "local_path": "/workspaces/{id}/repo",
  "created_at": "2026-02-06T14:30:00Z"
}

Errors:
  400: Invalid file or exceeds size limit
  401: Unauthorized
  413: Payload too large (>1GB)
```

### 5.2 List Workspace Files

```yaml
GET /api/workspaces/{workspace_id}/files?path=/
Authorization: Bearer {token}

Query Parameters:
  path: string (default: "/")

Response: 200 OK
{
  "workspace_id": "uuid",
  "current_path": "/",
  "parent_path": null,
  "items": [
    {
      "name": "src",
      "path": "/src",
      "type": "directory",
      "size": null,
      "modified_at": "2026-02-06T14:30:00Z"
    },
    {
      "name": "README.md",
      "path": "/README.md",
      "type": "file",
      "size": 2345,
      "modified_at": "2026-02-06T14:30:00Z"
    }
  ]
}

Errors:
  401: Unauthorized
  403: Access denied
  404: Workspace or path not found
```

### 5.3 Download File

```yaml
GET /api/workspaces/{workspace_id}/files/download?path=/README.md
Authorization: Bearer {token}

Query Parameters:
  path: string (required)

Response: 200 OK
Content-Type: application/octet-stream
Content-Disposition: attachment; filename="README.md"

<file_contents>

Errors:
  401: Unauthorized
  403: Access denied
  404: File not found
```

### 5.4 Download Folder as ZIP

```yaml
GET /api/workspaces/{workspace_id}/files/download-zip?path=/output
Authorization: Bearer {token}

Query Parameters:
  path: string (default: "/")

Response: 200 OK
Content-Type: application/zip
Content-Disposition: attachment; filename="output.zip"

<zip_contents>

Errors:
  401: Unauthorized
  403: Access denied
  404: Path not found
```

### 5.5 Upload File to Workspace

```yaml
POST /api/workspaces/{workspace_id}/files/upload
Content-Type: multipart/form-data
Authorization: Bearer {token}

Request:
  path: string               # Target directory path
  file: <file>               # File to upload

Response: 201 Created
{
  "name": "document.pdf",
  "path": "/uploads/document.pdf",
  "type": "file",
  "size": 12345,
  "modified_at": "2026-02-06T14:30:00Z"
}

Errors:
  400: Invalid file
  401: Unauthorized
  403: Access denied (no upload permission)
  404: Workspace not found
```

### 5.6 View File Content

```yaml
GET /api/workspaces/{workspace_id}/files/view?path=/README.md
Authorization: Bearer {token}

Query Parameters:
  path: string (required)

Response: 200 OK
{
  "name": "README.md",
  "path": "/README.md",
  "type": "file",
  "size": 2345,
  "modified_at": "2026-02-06T14:30:00Z",
  "content": "# My Project\n\nThis is the readme...",
  "content_type": "text/markdown",
  "is_binary": false
}

Errors:
  401: Unauthorized
  403: Access denied
  404: File not found
  413: File too large to view (>1MB)
```

---

## 6. Frontend Implementation

### 6.1 New Components

| Component | File | Description |
|-----------|------|-------------|
| `UploadModal` | `components/workspace/UploadModal.tsx` | Folder upload with drag-drop |
| `FileBrowser` | `components/workspace/FileBrowser.tsx` | File listing with navigation |
| `FileViewer` | `components/workspace/FileViewer.tsx` | File content viewer modal |
| `FileUploader` | `components/workspace/FileUploader.tsx` | Single file upload component |

### 6.2 Agents Tab Changes

**File**: `frontend/src/app/(app)/codex/page.tsx`

```typescript
// Add new state
const [showUploadModal, setShowUploadModal] = useState(false);
const [viewMode, setViewMode] = useState<"transcript" | "raw" | "files">("transcript");

// Add Upload button next to Import/Scan/Remove
<button
  onClick={() => setShowUploadModal(true)}
  className="text-xs text-green-600 hover:text-green-800"
  title="Upload local folder"
>
  ğŸ“¤ Upload
</button>

// Add Files tab in Output panel
<button
  onClick={() => setViewMode("files")}
  className={`px-2 py-1 text-xs rounded ${
    viewMode === "files" ? "bg-zinc-900 text-white" : "bg-zinc-100"
  }`}
>
  ğŸ“ Files
</button>

// Render FileBrowser when files tab selected
{viewMode === "files" && selectedWorkspaceId && (
  <FileBrowser workspaceId={selectedWorkspaceId} />
)}
```

### 6.3 Chat UI Changes

**File**: `frontend/src/app/(app)/chat/page.tsx`

```typescript
// Add Files panel in sidebar
<div className="border-t border-zinc-200 p-4">
  <div className="flex items-center justify-between mb-2">
    <span className="text-xs font-medium text-zinc-500">ğŸ“ Files</span>
    <button onClick={toggleFilesPanel} className="text-xs text-zinc-400">
      {showFiles ? "â–¼" : "â–¶"}
    </button>
  </div>
  {showFiles && selectedWorkspaceId && (
    <FileBrowser 
      workspaceId={selectedWorkspaceId} 
      compact={true}
    />
  )}
</div>
```

### 6.4 New API Routes

| Route | File |
|-------|------|
| `POST /api/workspaces/upload` | `frontend/src/app/api/workspaces/upload/route.ts` |
| `GET /api/workspaces/[id]/files` | `frontend/src/app/api/workspaces/[workspaceId]/files/route.ts` |
| `GET /api/workspaces/[id]/files/download` | `frontend/src/app/api/workspaces/[workspaceId]/files/download/route.ts` |
| `GET /api/workspaces/[id]/files/download-zip` | `frontend/src/app/api/workspaces/[workspaceId]/files/download-zip/route.ts` |
| `POST /api/workspaces/[id]/files/upload` | `frontend/src/app/api/workspaces/[workspaceId]/files/upload/route.ts` |
| `GET /api/workspaces/[id]/files/view` | `frontend/src/app/api/workspaces/[workspaceId]/files/view/route.ts` |

---

## 7. Database Schema Changes

### 7.1 New Tables

```sql
-- Tenants (NHS Trusts)
CREATE TABLE tenants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata_json JSONB
);

-- Groups for RBAC
CREATE TABLE groups (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(tenant_id, name)
);

-- User-Group membership
CREATE TABLE user_groups (
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    group_id UUID NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
    role VARCHAR(20) DEFAULT 'member',
    added_at TIMESTAMPTZ DEFAULT NOW(),
    added_by UUID REFERENCES users(id),
    PRIMARY KEY (user_id, group_id)
);

-- Workspace access grants
CREATE TABLE workspace_access (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
    grantee_type VARCHAR(20) NOT NULL CHECK (grantee_type IN ('user', 'group')),
    grantee_id UUID NOT NULL,
    access_level VARCHAR(20) NOT NULL CHECK (access_level IN ('owner', 'editor', 'viewer')),
    granted_at TIMESTAMPTZ DEFAULT NOW(),
    granted_by UUID REFERENCES users(id),
    UNIQUE(workspace_id, grantee_type, grantee_id)
);

CREATE INDEX ix_workspace_access_workspace ON workspace_access(workspace_id);
CREATE INDEX ix_workspace_access_grantee ON workspace_access(grantee_type, grantee_id);
```

### 7.2 Table Modifications

```sql
-- Add tenant_id to users (if not exists)
ALTER TABLE users ADD COLUMN IF NOT EXISTS tenant_id UUID REFERENCES tenants(id);

-- Add owner_id to workspaces
ALTER TABLE workspaces ADD COLUMN IF NOT EXISTS owner_id UUID REFERENCES users(id);

-- Update source_type to include 'upload'
-- (No schema change needed, just new value)
```

---

## 8. Security Considerations

### 8.1 Path Traversal Prevention

```python
def validate_path(workspace_path: str, requested_path: str) -> str:
    """Ensure requested path is within workspace directory."""
    base = pathlib.Path(workspace_path).resolve()
    target = (base / requested_path.lstrip("/")).resolve()
    
    if not str(target).startswith(str(base)):
        raise HTTPException(status_code=400, detail="Invalid path")
    
    return str(target)
```

### 8.2 File Size Limits

| Operation | Limit |
|-----------|-------|
| Workspace upload (ZIP) | 1GB |
| Single file upload | 100MB |
| File view (in browser) | 1MB |
| Download | No limit |

### 8.3 Content Type Validation

```python
ALLOWED_VIEW_TYPES = {
    ".md", ".txt", ".json", ".yaml", ".yml", ".xml",
    ".py", ".js", ".ts", ".tsx", ".jsx", ".java",
    ".html", ".css", ".sql", ".sh", ".bash",
    ".csv", ".log", ".conf", ".ini", ".toml"
}

def can_view_in_browser(filename: str) -> bool:
    return pathlib.Path(filename).suffix.lower() in ALLOWED_VIEW_TYPES
```

### 8.4 Tenant Isolation

All file operations MUST verify:
1. User is authenticated
2. User belongs to workspace's tenant
3. User has appropriate permission level

---

## 9. Implementation Checklist

### Phase 1: Backend API (Priority: High)

- [ ] Add `owner_id` column to workspaces table
- [ ] Create RBAC tables (groups, user_groups, workspace_access)
- [ ] Implement `POST /api/workspaces/upload` endpoint
- [ ] Implement `GET /api/workspaces/{id}/files` endpoint
- [ ] Implement `GET /api/workspaces/{id}/files/download` endpoint
- [ ] Implement `GET /api/workspaces/{id}/files/download-zip` endpoint
- [ ] Implement `POST /api/workspaces/{id}/files/upload` endpoint
- [ ] Implement `GET /api/workspaces/{id}/files/view` endpoint
- [ ] Add RBAC permission checks to all file endpoints
- [ ] Add path traversal protection
- [ ] Add file size validation

### Phase 2: Frontend - Agents Tab (Priority: High)

- [ ] Add "ğŸ“¤ Upload" button to workspace panel
- [ ] Create UploadModal component with drag-drop
- [ ] Integrate JSZip for folder zipping
- [ ] Add upload progress indicator
- [ ] Add "ğŸ“ Files" tab to Output panel
- [ ] Create FileBrowser component
- [ ] Create FileViewer modal component
- [ ] Add file upload to workspace functionality
- [ ] Add download buttons (single file, ZIP)

### Phase 3: Frontend - Chat UI (Priority: High)

- [ ] Add Files panel to sidebar
- [ ] Integrate FileBrowser component (compact mode)
- [ ] Add upload/download buttons
- [ ] Sync file browser with selected workspace

### Phase 4: RBAC Integration (Priority: Medium)

- [ ] Create Group model and repository
- [ ] Create WorkspaceAccess model and repository
- [ ] Implement permission checking middleware
- [ ] Add owner assignment on workspace creation
- [ ] Add default viewer access for tenant users
- [ ] Create admin UI for managing workspace access (placeholder)

### Phase 5: Testing & Documentation (Priority: Medium)

- [ ] Unit tests for file operations
- [ ] Integration tests for upload/download
- [ ] E2E tests for full workflow
- [ ] Update API documentation
- [ ] Update user guide

---

## Appendix: File Structure After Implementation

```
frontend/src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ (app)/
â”‚   â”‚   â”œâ”€â”€ codex/page.tsx          # Updated with Upload + Files tab
â”‚   â”‚   â””â”€â”€ chat/page.tsx           # Updated with Files panel
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ workspaces/
â”‚           â”œâ”€â”€ upload/route.ts     # NEW
â”‚           â””â”€â”€ [workspaceId]/
â”‚               â””â”€â”€ files/
â”‚                   â”œâ”€â”€ route.ts         # NEW - list files
â”‚                   â”œâ”€â”€ download/route.ts    # NEW
â”‚                   â”œâ”€â”€ download-zip/route.ts # NEW
â”‚                   â”œâ”€â”€ upload/route.ts      # NEW
â”‚                   â””â”€â”€ view/route.ts        # NEW
â”œâ”€â”€ components/
â”‚   â””â”€â”€ workspace/
â”‚       â”œâ”€â”€ UploadModal.tsx         # NEW
â”‚       â”œâ”€â”€ FileBrowser.tsx         # NEW
â”‚       â”œâ”€â”€ FileViewer.tsx          # NEW
â”‚       â””â”€â”€ FileUploader.tsx        # NEW

backend/app/
â”œâ”€â”€ main.py                         # Updated with file endpoints
â”œâ”€â”€ models.py                       # Updated with RBAC models
â”œâ”€â”€ repositories/
â”‚   â”œâ”€â”€ group_repository.py         # NEW
â”‚   â””â”€â”€ workspace_access_repository.py  # NEW
â””â”€â”€ services/
    â””â”€â”€ file_service.py             # NEW - file operations
```

---

*Document Version: 1.0*
*Created: Feb 6, 2026*
*Author: Cascade AI Assistant*
